#!/usr/bin/env python3

import csv
import dateutil
import logging
import os
import pprint
import sys

HEADER_ORDER = [
    'Device',
    'Serial Number',
    'Device Timestamp',
    'Record Type',
    'Historic Glucose mg/dL',
    'Scan Glucose mg/dL',
    'Non-numeric Rapid-Acting Insulin',
    'Rapid-Acting Insulin (units)',
    'Non-numeric Food',
    'Carbohydrates (grams)',
    'Carbohydrates (servings)',
    'Non-numeric Long-Acting Insulin',
    'Long-Acting Insulin (units)',
    'Notes',
    'Strip Glucose mg/dL',
    'Ketone mmol/L',
    'Meal Insulin (units)',
    'Correction Insulin (units)',
    'User Change Insulin (units)',
]

BUILT_IN_HEADERS = {
    'Device': 'device',
    'Serial Number': 'sn',
    'Device Timestamp': 'timestamp',
    'Record Type': 'type',
    'Historic Glucose mg/dL': 'historic_glucose',
    'Scan Glucose mg/dL': 'glucose',
    'Non-numeric Rapid-Acting Insulin': 'nnra_insulin',
    'Rapid-Acting Insulin (units)': 'rai_units',
    'Non-numeric Food': 'food',
    'Carbohydrates (grams)': 'carbs_g',
    'Carbohydrates (servings)': 'carbs_serv',
    'Non-numeric Long-Acting Insulin': 'nnla_insulin',
    'Long-Acting Insulin (units)': 'lai_units',
    'Notes': 'notes',
    'Strip Glucose mg/dL': 'strip_glucose',
    'Ketone mmol/L': 'ketone',
    'Meal Insulin (units)': 'meal_insulin',
    'Correction Insulin (units)': 'correction_insulin',
    'User Change Insulin (units)': 'user_change_insulin',
}

"""
Example row:
[{'carbs_g': '',
  'carbs_serv': '',
  'correction_insulin': '',
  'device': 'FreeStyle LibreLink',
  'food': '',
  'glucose': '',
  'historic_glucose': '98',
  'ketone': '',
  'lai_units': '',
  'meal_insulin': '',
  'nnla_insulin': '',
  'nnra_insulin': '',
  'notes': '',
  'rai_units': '',
  'sn': '1b2333b8-1234-4cde-abcd-1ab23cdefga4',
  'strip_glucose': '',
  'timestamp': '12-28-2021 06:40 PM',
  'type': '0',
  'user_change_insulin': ''}]
"""
def main():
    print(f"File to output: {sys.argv[1]}")


    time = []
    data = {}
    config = {
        'target_min':70,
        'target_max':180,
    }

    # TODO: generate data

    with open(sys.argv[1], 'w') as f:
        curdate = '03-29-2022 03:19 AM UTC'
        f.write(f"Glucose Data,Generated on,{curdate},Generated by,{os.getlogin()}\n")
        f.write(HEADER_ORDER.join(","), "\n")
        # TODO: write csv data
    sys.exit(0)

if __name__ == '__main__':
    main()
